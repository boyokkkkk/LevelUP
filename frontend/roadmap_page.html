<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>LevelUP - 学习路径</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        :root {
            --main-bg: #fff;
            --main-text: #222;
            --main-purple: #6b4eff;
            --main-blue: #9cd6ff;
            --main-border: #e6eaf0;
            --main-gray: #888;
        }
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            margin: 0;
            background: var(--main-bg);
            color: var(--main-text);
            background-image: radial-gradient(circle at center, rgba(107, 78, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .nav-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--main-bg);
            padding: 0 40px;
            height: 60px;
            box-shadow: 0 2px 8px rgba(107, 78, 255, 0.08);
            opacity: 0;
            animation: fadeInDown 0.8s ease-out forwards;
        }
        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .nav-logo {
            font-size: 2em;
            font-weight: bold;
            color: var(--main-purple);
            letter-spacing: 2px;
        }
        .nav-search {
            position: relative;
            width: 400px;
            display: flex;
            justify-content: center;
        }
        .nav-search input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            outline: none;
            background: #f8fafc;
            color: var(--main-text);
            box-shadow: 0 2px 8px rgba(163, 216, 255, 0.04);
        }
        .nav-avatar img {
            border-radius: 50%;
            width: 40px;
            border: 2px solid var(--main-purple);
        }
        .btn {
            background: var(--main-purple);
            color: var(--main-bg);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1em;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .btn:hover {
            background: var(--main-blue);
            color: var(--main-purple);
        }
        .btn.secondary {
            background: var(--main-blue);
            color: var(--main-purple);
            border: none;
        }
        .btn.secondary:hover {
            background: var(--main-purple);
            color: #fff;
        }
        .btn.cancel {
            background: #e6eaf0 !important;
            color: #555 !important;
            border: none !important;
        }
        .btn.cancel:hover {
            background: #cfd8dc !important;
            color: #222 !important;
        }
        .back-btn {
            display: inline-block;
            margin: 40px 0 18px 40px;
            color: #6b4eff;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
        }
        .back-btn:hover {
            text-decoration: underline;
        }
        .title {
            font-size: 2em;
            font-weight: bold;
            color: #6b4eff;
            margin: 0 0 10px 40px;
        }
        .subtitle {
            color: #888;
            margin: 0 0 24px 40px;
        }
        .roadmap-list {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 60px;
            position: relative;
        }
        .roadmap-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            min-height: 64px;
            margin-bottom: clamp(40px, 6vh, 64px);
        }
        .main-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 220px;
            min-width: 180px;
            max-width: 320px;
            margin-left: 60px;
            position: relative;
            min-height: 64px;
        }
        .main-cell.empty {
            background: none;
            border: none;
            box-shadow: none;
            width: 220px;
            min-width: 180px;
            max-width: 320px;
            margin-left: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 24px;
        }
        .main-node, .branch-node {
            max-width: 260px;
            word-break: break-all;
            white-space: normal;
        }
        .main-node {
            background: #6b4eff;
            color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(107,78,255,0.07);
            border: 2px solid #e3f2fd;
            width: 100%;
            padding: 18px 24px;
            font-size: clamp(1em, 2vw, 1.2em);
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: box-shadow 0.2s, background 0.2s;
            margin-bottom: 8px;
            z-index: 2;
        }
        .main-node:hover {
            background: #4b36c7;
        }
        .arrow-svg {
            display: block;
            margin: 0 auto;
            z-index: 1;
            width: 32px;
            height: 36px;
            overflow: visible;
        }
        .branch-connector {
            width: 100px;
            min-width: 80px;
            height: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .branch-cell {
            display: flex;
            flex-direction: row;
            align-items: center;
            min-width: 0;
            min-height: 64px;
        }
        .branch-node {
            background: #fff;
            color: #6b4eff;
            border: 2px dashed #9cd6ff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(107,78,255,0.07);
            min-width: 120px;
            max-width: 220px;
            padding: 16px 20px;
            font-size: clamp(0.95em, 1.8vw, 1.1em);
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            user-select: none;
            margin-left: 0;
            margin-right: 0;
            margin-bottom: 0;
            z-index: 2;
        }
        .branch-node:hover {
            background: #f0f2f5;
        }
        /* 右键菜单样式 */
        .context-menu {
            position: absolute;
            z-index: 30000;
            background: #fff;
            border: 1.5px solid #e6eaf0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(107,78,255,0.08);
            min-width: 160px;
            font-size: 1em;
            padding: 6px 0;
        }
        .context-menu-item {
            padding: 10px 22px;
            color: #222;
            cursor: pointer;
            transition: background 0.15s;
        }
        .context-menu-item:hover {
            background: #f0f2f5;
            color: #6b4eff;
        }
        @media (max-width: 900px) {
            .main-cell, .branch-node {
                min-width: 80px;
                max-width: 98vw;
                padding: 12px 4vw;
                font-size: 1em;
            }
            .roadmap-list {
                max-width: 100vw;
            }
        }
        .main-arrow-abs {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }
        .branch-dash-abs {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }
        .container {
            display: flex;
            padding: 24px 0 0 8px;
            gap: 20px;
            max-width: 1300px;
            margin: 0 auto;
        }
        .sidebar {
            width: 220px;
            background: var(--main-bg);
            border-radius: 12px;
            padding: 18px 16px;
            box-shadow: 0 2px 8px rgba(163, 216, 255, 0.06);
            min-width: 180px;
            border: 1.5px solid var(--main-border);
        }
        .sidebar h3 {
            color: var(--main-purple);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .sidebar .avatar {
            display: block;
            margin: 0 auto 10px auto;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            object-fit: cover;
            border: 2px solid var(--main-purple);
        }
        .sidebar .username {
            text-align: center;
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 2px;
            color: var(--main-text);
        }
        .sidebar hr {
            width: 90%;
            border: none;
            border-top: 1px solid var(--main-border);
            margin: 12px auto;
        }
        .sidebar .section-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 6px;
            color: var(--main-purple);
            font-size: 1em;
        }
        .sidebar .btn {
            width: 92%;
            padding: 8px 0;
            margin: 0 auto 8px auto;
            border: none;
            border-radius: 8px;
            background: var(--main-purple);
            color: var(--main-bg);
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            display: block;
        }
        .sidebar .btn:hover {
            background: var(--main-blue);
            color: var(--main-text);
        }
        .sidebar .btn.secondary {
            background: var(--main-blue);
            color: var(--main-purple);
        }
        .add-todo-btn {
            width: 92%;
            padding: 8px 0;
            margin: 10px auto 8px auto;
            border: none;
            border-radius: 8px;
            background: var(--main-purple);
            color: var(--main-bg);
            font-weight: bold;
            font-size: 1.5em;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: block;
            line-height: 1;
            text-align: center;
        }
        .add-todo-btn:hover {
            background: var(--main-blue);
            color: var(--main-text);
            transform: scale(1.05);
        }
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0 auto;
            width: 92%;
        }
        .todo-list li {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid var(--main-border);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: var(--main-text);
            transition: background 0.2s;
            cursor: pointer;
        }
        .todo-list li.completed {
            background: #e6eaf0;
            text-decoration: line-through;
            color: var(--main-gray);
        }
        .todo-circle {
            width: 16px;
            height: 16px;
            border: 2px solid var(--main-purple);
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s;
        }
        .todo-circle.completed {
            background-color: var(--main-purple);
            border-color: var(--main-purple);
        }
        .todo-circle.completed::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 8px;
            background-color: var(--main-bg);
            border-radius: 50%;
        }
        .todo-list li .todo-text {
            flex: 1;
            word-break: break-word;
        }
        .todo-list .no-todos-message {
            text-align: center;
            color: var(--main-gray);
            padding: 10px 0;
            font-size: 0.85em;
            width: 100%;
            margin: 10px auto;
        }
        /* 统一主节点和分支节点三种状态配色 */
        .main-node.status-todo, .branch-node.status-todo {
            background: #f8fafc;
            color: #6b7a99;
            border: 2px solid #b0b8c9;
        }
        .main-node.status-doing, .branch-node.status-doing {
            background: #fffbe6;
            color: #b88600;
            border: 2px solid #ffb300;
        }
        .main-node.status-done, .branch-node.status-done {
            background: #e6f7ff;
            color: #389e0d;
            border: 2px solid #52c41a;
        }
        .main-node.status-todo:hover, .branch-node.status-todo:hover {
            background: #e6eaf0;
        }
        .main-node.status-doing:hover, .branch-node.status-doing:hover {
            background: #fff3c1;
        }
        .main-node.status-done:hover, .branch-node.status-done:hover {
            background: #c6f5d7;
        }
        .context-menu-item.status-menu-parent {
            position: relative;
        }
        .context-menu-sub {
            left: 100%;
            top: 0;
            position: absolute;
            background: #fff;
            border: 1.5px solid #e6eaf0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(107,78,255,0.08);
            min-width: 140px;
            font-size: 1em;
            padding: 6px 0;
            z-index: 10000;
        }
        .sidebar .progress-title {
            text-align: center;
            color: var(--main-purple);
            font-weight: bold;
            margin: 10px 0 4px 0;
            font-size: 1em;
        }
        .sidebar .progress-bar-bg {
            width: 92%;
            height: 16px;
            background: #f0f2f5;
            border-radius: 8px;
            margin: 0 auto 6px auto;
            position: relative;
        }
        .sidebar .progress-bar {
            height: 100%;
            background: #52c41a;
            border-radius: 8px;
            transition: width 0.4s cubic-bezier(.4,2,.6,1);
        }
        .sidebar .progress-percent {
            text-align: right;
            color: #389e0d;
            font-size: 0.95em;
            margin-right: 8px;
            font-weight: bold;
        }
        .sidebar .target-title {
            text-align: center;
            color: var(--main-purple);
            font-size: 1.25em;
            font-weight: bold;
            margin: 0 0 10px 0;
            letter-spacing: 1px;
        }
        .sidebar .progress-detail {
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px 12px;
            margin: 8px 0 0 0;
            font-size: 0.98em;
            color: #444;
            box-shadow: 0 1px 4px rgba(107,78,255,0.04);
        }
        .sidebar .progress-detail span {
            display: inline-block;
            min-width: 80px;
            color: #6b4eff;
            font-weight: bold;
        }
        .stat-card {
            background: #f8fafc;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(107,78,255,0.04);
            padding: 12px 14px 10px 14px;
            margin-bottom: 14px;
        }
        .stat-title {
            font-weight: bold;
            color: #6b4eff;
            font-size: 1.08em;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        .stat-row {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 1em;
            margin-bottom: 2px;
            flex-wrap: wrap;
        }
        .stat-row.stat-total {
            margin-bottom: 8px;
            font-size: 1.08em;
        }
        .stat-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 0.95em;
            margin-bottom: 0;
        }
        .stat-item.stat-total {
            margin-bottom: 8px;
            font-size: 1.08em;
        }
        .stat-item.stat-total span {
            display: inline-block;
            min-width: 80px;
            color: #6b4eff;
            font-weight: bold;
        }
        .stat-item.stat-total span.stat-label {
            color: #6b4eff;
            font-weight: bold;
            margin-right: 2px;
        }
        .stat-item.stat-total span.stat-num {
            font-weight: bold;
            min-width: 1.2em;
            display: inline-block;
            text-align: right;
            color: #222;
            margin-right: 0;
        }
        .stat-item.stat-total span.stat-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 1px;
            vertical-align: middle;
        }
        .stat-item.stat-total span.stat-dot.done { background: #52c41a; }
        .stat-item.stat-total span.stat-dot.doing { background: #ffb300; }
        .stat-item.stat-total span.stat-dot.todo { background: #b0b8c9; }
        .stat-item span.stat-label {
            color: #6b4eff;
            font-weight: bold;
            margin-right: 2px;
        }
        .stat-item span.stat-num {
            font-weight: bold;
            min-width: 1.2em;
            display: inline-block;
            text-align: right;
            color: #222;
            margin-right: 0;
        }
        .stat-item span.stat-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 1px;
            vertical-align: middle;
        }
        .stat-item span.stat-dot.done { background: #52c41a; }
        .stat-item span.stat-dot.doing { background: #ffb300; }
        .stat-item span.stat-dot.todo { background: #b0b8c9; }
        @media (max-width: 700px) {
            .stat-flex { flex-direction: column; gap: 10px; }
            .stat-col { width: 100%; }
        }
        .node-detail-drawer {
            position: fixed;
            top: 72px;
            right: 0;
            width: 340px;
            height: calc(100vh - 72px);
            background: #fff;
            box-shadow: -4px 0 24px rgba(107,78,255,0.10);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
            animation: slideInDrawer 0.22s cubic-bezier(.4,0.8,.6,1);
        }
        @keyframes slideInDrawer {
            0% { right: -40px; opacity: 0; }
            100% { right: 0; opacity: 1; }
        }
        .slide-fade-enter-active, .slide-fade-leave-active {
            transition: opacity 0.22s cubic-bezier(.4,0.8,.6,1), transform 0.22s cubic-bezier(.4,0.8,.6,1);
        }
        .slide-fade-enter-from, .slide-fade-leave-to {
            opacity: 0;
            transform: translateX(40px);
        }
        @media (max-width: 700px) {
            .node-detail-drawer {
                width: 98vw;
                min-width: 0;
                border-radius: 0;
            }
        }
        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px 10px 24px;
            border-bottom: 1px solid #e6eaf0;
        }
        .drawer-title {
            font-size: 1.25em;
            font-weight: bold;
            color: #222;
            word-break: break-all;
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.6em;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .drawer-close:hover {
            color: #6b4eff;
        }
        .drawer-content {
            flex: 1;
            padding: 24px 24px 0 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .drawer-title-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 2px;
        }
        .drawer-node-label {
            font-size: 1.18em;
            font-weight: bold;
            color: #6b4eff;
            margin-bottom: 3px;
            letter-spacing: 0.5px;
            word-break: break-all;
            width: 100%;
            text-align: left;
        }
        .drawer-status-row2 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            font-size: 0.93em;
            color: #888;
            width: 100%;
        }
        .drawer-status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
            background: #b0b8c9;
        }
        .drawer-status-dot.status-todo { background: #b0b8c9; }
        .drawer-status-dot.status-doing { background: #ffb300; }
        .drawer-status-dot.status-done { background: #52c41a; }
        .drawer-status-text2 {
            font-size: 0.93em;
            color: #888;
        }
        .drawer-edit-form-group {
            margin-bottom: 14px;
            width: 100%;
        }
        .drawer-edit-label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #222;
            font-size: 1em;
        }
        .drawer-edit-input {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #e6eaf0;
            border-radius: 8px;
            font-size: 1.08em;
            background: #fff;
            color: #6b4eff;
            font-weight: bold;
            margin-bottom: 0;
            box-sizing: border-box;
        }
        .drawer-status-select {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #e6eaf0;
            border-radius: 8px;
            font-size: 1em;
            background: #fff;
            color: #b0b8c9;
            margin-bottom: 0;
            box-sizing: border-box;
            outline: none;
        }
        /* 下拉框本身字体色随选中项变化 */
        .drawer-status-select.status-todo { color: #b0b8c9; }
        .drawer-status-select.status-doing { color: #ffb300; }
        .drawer-status-select.status-done { color: #52c41a; }
        /* 下拉选项始终三色 */
        .drawer-status-select option[value="todo"] { color: #b0b8c9; }
        .drawer-status-select option[value="doing"] { color: #ffb300; }
        .drawer-status-select option[value="done"] { color: #52c41a; }
        .drawer-edit-remark {
            width: 100%;
            min-height: 80px;
            border-radius: 8px;
            border: 1.5px solid #e6eaf0;
            padding: 10px;
            font-size: 1em;
            background: #fff;
            color: #444;
            margin-bottom: 0;
            resize: vertical;
            box-sizing: border-box;
        }
        .drawer-btn-row {
            display: flex;
            gap: 18px;
            margin-top: 18px;
            width: 100%;
            justify-content: flex-end;
        }
        .drawer-edit, .drawer-save {
            background: #6b4eff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            padding: 10px 20px;
            font-weight: bold;
            transition: background 0.2s, color 0.2s;
        }
        .drawer-edit:hover, .drawer-save:hover {
            background: #9cd6ff;
            color: #6b4eff;
        }
        .drawer-cancel {
            background: #f8fafc;
            color: #6b4eff;
            border: 1.5px solid #e6eaf0;
            border-radius: 8px;
            font-size: 1em;
            padding: 10px 20px;
            font-weight: bold;
            transition: background 0.2s, color 0.2s;
            margin-left: 16px;
        }
        .drawer-cancel:hover {
            background: #e6eaf0;
            color: #222;
        }
        /* 备注label与编辑label风格统一 */
        .drawer-label {
            display: block;
            font-weight: bold;
            color: #222;
            font-size: 1em;
            margin-bottom: 6px;
            width: 100%;
            text-align: left;
            margin-top: 18px;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(107,78,255,0.10);
            z-index: 30000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(107,78,255,0.18);
            padding: 32px 32px 24px 32px;
            min-width: 340px;
            max-width: 96vw;
            min-height: 0;
            position: relative;
            animation: fadeInModal 0.18s cubic-bezier(.4,0.8,.6,1);
        }
        @keyframes fadeInModal {
            0% { opacity: 0; transform: scale(0.98) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.7em;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 1;
        }
        .modal-close-btn:hover {
            color: #6b4eff;
        }
        .target-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .form-title {
            font-size: 1.25em;
            font-weight: bold;
            color: #6b4eff;
            margin-bottom: 8px;
            text-align: center;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-weight: bold;
            color: #222;
            font-size: 1em;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1.5px solid #e6eaf0;
            border-radius: 8px;
            font-size: 1.08em;
            background: #fff;
            color: #6b4eff;
            font-weight: bold;
            margin-bottom: 0;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .form-actions {
            display: flex;
            gap: 18px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        .search-highlight {
            background: #e6eaf0;
            color: #6b4eff;
            border-radius: 4px;
            font-weight: bold;
            padding: 0 2px;
            box-shadow: 0 1px 4px rgba(107,78,255,0.03);
        }
        .search-dropdown {
            position: absolute;
            left: 0;
            width: 100%;
            top: 100%;
            background: #fff;
            border: 1.5px solid #e6eaf0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(107,78,255,0.08);
            z-index: 2147483647;
            max-height: 144px; /* 4项，每项36px */
            min-height: 144px;
            overflow-y: auto;
        }
        .search-dropdown-item {
            padding: 7px 14px;
            min-height: 36px;
            cursor: pointer;
            font-size: 1em;
            color: #222;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-dropdown-item.active, .search-dropdown-item:hover {
            background: #f0f2f5;
            color: #6b4eff;
        }
        .search-dropdown-item.no-result {
            min-height: 56px;
            justify-content: center;
            color: #aaa;
            cursor: default;
        }
        .dropdown-branch {
            padding-left: 52px;
        }
        .dropdown-status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
            background: #b0b8c9;
        }
        .dropdown-status-dot.status-todo { background: #b0b8c9; }
        .dropdown-status-dot.status-doing { background: #ffb300; }
        .dropdown-status-dot.status-done { background: #52c41a; }
        .search-locate-highlight {
            box-shadow: 0 0 0 4px #9cd6ff, 0 2px 8px rgba(107,78,255,0.10);
            transition: box-shadow 0.2s;
            z-index: 20000;
        }
        .search-dropdown.no-scroll {
            overflow-y: visible !important;
            max-height: none !important;
        }
        .todo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .todo-modal-content {
            background-color: var(--main-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .todo-form-title {
            font-size: 2em;
            color: var(--main-purple);
            margin-bottom: 24px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .todo-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .todo-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--main-text);
        }
        .todo-form .form-group input {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--main-border);
            border-radius: 8px;
            font-size: 1em;
            background: #f8fafc;
            color: var(--main-text);
        }
        .todo-form .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .todo-form .form-actions .btn {
            width: auto;
            padding: 10px 20px;
            margin: 0;
        }
        .btn.cancel {
            background: #e6eaf0 !important;
            color: #555 !important;
            border: none !important;
        }
        .btn.cancel:hover {
            background: #cfd8dc !important;
            color: #222 !important;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="nav-header">
        <div class="nav-logo">LevelUP</div>
        <div class="nav-search" style="position:relative;">
            <input type="text" placeholder="搜索学习目标、技能点或笔记标题…"
                   v-model="search"
                   @focus="onSearchFocus"
                   @blur="onSearchBlur"
                   @keydown="onSearchKeydown"
                   ref="searchInputRef">
            <div v-if="showDropdown"
                 class="search-dropdown"
                 :class="{'no-scroll': dropdownOptions.length === 0 && search.trim() !== ''}"
                 :style="dropdownOptions.length ? {maxHeight: '144px'} : {minHeight: dropdownHeight}">
                <template v-if="dropdownOptions.length">
                    <template v-for="(opt, i) in dropdownOptions" :key="opt.type + '-' + opt.id">
                        <div :class="['search-dropdown-item', {active: i === dropdownIndex, 'dropdown-branch': opt.type==='branch'}]"
                             @mousedown.prevent="locateNode(opt)">
                            <span class="dropdown-status-dot" :class="'status-' + opt.status"></span>
                            <span v-html="highlight(opt.label)"></span>
                        </div>
                    </template>
                </template>
                <div v-else-if="search.trim() !== ''" class="search-dropdown-item no-result">
                    未找到相关技能点
                </div>
            </div>
        </div>
        <div class="nav-avatar">
            <a href="main_web.html" class="btn" style="text-decoration:none;">返回主页</a>
        </div>
    </div>
    <div style="margin-top:24px;">
    <div class="container">
            <div class="sidebar">
                <div class="target-title">{{ targetId }}</div>
                <div class="progress-title">学习率</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar" :style="{width: branchProgressPercent + '%'}"></div>
                </div>
                <div class="progress-percent">{{ branchProgressPercent }}%</div>
                <hr>
                <div class="stat-flex">
                    <div class="stat-col">
                        <div class="stat-title">主技能点 {{ mainCount }}</div>
                        <div class="stat-item"><span class="stat-dot done"></span><span class="stat-label">已学习</span><span class="stat-num">{{ mainStatus.done }}</span></div>
                        <div class="stat-item"><span class="stat-dot doing"></span><span class="stat-label">学习中</span><span class="stat-num">{{ mainStatus.doing }}</span></div>
                        <div class="stat-item"><span class="stat-dot todo"></span><span class="stat-label">待学习</span><span class="stat-num">{{ mainStatus.todo }}</span></div>
                    </div>
                    <div class="stat-col">
                        <div class="stat-title">分技能点 {{ branchCount }}</div>
                        <div class="stat-item"><span class="stat-dot done"></span><span class="stat-label">已学习</span><span class="stat-num">{{ branchStatus.done }}</span></div>
                        <div class="stat-item"><span class="stat-dot doing"></span><span class="stat-label">学习中</span><span class="stat-num">{{ branchStatus.doing }}</span></div>
                        <div class="stat-item"><span class="stat-dot todo"></span><span class="stat-label">待学习</span><span class="stat-num">{{ branchStatus.todo }}</span></div>
                    </div>
                </div>
                <hr>
                <div class="section-title">待办事项</div>
                <button class="btn add-todo-btn" @click="openTodoForm">+</button>
                <ul class="todo-list">
                    <li v-for="(todo, idx) in todos" :key="todo.id" @click="toggleTodoComplete(todo)" :class="{ 'completed': todo.completed, 'fade-out': todo.isDeleting }">
                        <span class="todo-circle" :class="{ 'completed': todo.completed }"></span>
                        <span class="todo-text">{{ todo.text }}</span>
                        <button class="icon-btn" title="删除" @click.stop="deleteTodo(todo)">🗑️</button>
                    </li>
                    <li v-if="todos.length === 0" class="no-todos-message">暂无待办事项</li>
                </ul>
                <!-- 新增：待办事项浮窗表单 -->
                <div class="todo-modal-overlay" v-if="showTodoAddForm">
                    <div class="todo-modal-content">
                        <button class="modal-close-btn" @click="cancelAddTodoForm">×</button>
                        <div class="todo-form">
                            <h3 class="todo-form-title">添加待办事项</h3>
                            <div class="form-group">
                                <label for="todoText">事项内容:</label>
                                <input type="text" id="todoText" v-model="newTodoText" @keyup.enter="addTodoFromForm" placeholder="例如：完成软件工程作业">
                            </div>
                            <div class="form-actions">
                                <button class="btn" @click="addTodoFromForm">添加</button>
                                <button class="btn cancel" @click="cancelAddTodoForm">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="section-title">设置 / 帮助</div>
                <button class="btn secondary" @click="jumpTo('设置')">设置</button>
                <button class="btn secondary" @click="jumpTo('帮助')">帮助</button>
                <!-- 新增：主技能点插入弹窗 -->
                <div class="todo-modal-overlay" v-if="showAddMainNodeModal">
                    <div class="todo-modal-content">
                        <button class="modal-close-btn" @click="cancelAddMainNodeModal">×</button>
                        <div class="todo-form">
                            <h3 class="todo-form-title">添加主技能点</h3>
                            <div class="form-group">
                                <label for="mainNodeTitle">技能点标题:</label>
                                <input type="text" id="mainNodeTitle" v-model="newMainNodeTitle" @keyup.enter="addMainNodeFromModal" placeholder="例如：数据结构基础">
                            </div>
                            <div class="form-actions">
                                <button class="btn" @click="addMainNodeFromModal">添加</button>
                                <button class="btn cancel" @click="cancelAddMainNodeModal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 新增：分支技能点插入弹窗 -->
                <div class="todo-modal-overlay" v-if="showAddBranchNodeModal">
                    <div class="todo-modal-content">
                        <button class="modal-close-btn" @click="cancelAddBranchNodeModal">×</button>
                        <div class="todo-form">
                            <h3 class="todo-form-title">添加分支技能点</h3>
                            <div class="form-group">
                                <label for="branchNodeTitle">技能点标题:</label>
                                <input type="text" id="branchNodeTitle" v-model="newBranchNodeTitle" @keyup.enter="addBranchNodeFromModal" placeholder="例如：链表与数组">
                            </div>
                            <div class="form-actions">
                                <button class="btn" @click="addBranchNodeFromModal">添加</button>
                                <button class="btn cancel" @click="cancelAddBranchNodeModal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="main-content" style="flex:1; min-width:0;">
                <div class="title">{{ targetId }}</div>
        <div class="subtitle">学习路径（Roadmap）</div>
                <div class="roadmap-list" ref="roadmapListRef">
                    <template v-for="(node, idx) in filteredRoadmap" :key="node.id">
                        <!-- 主技能点行 -->
                        <div class="roadmap-row">
                            <div class="main-cell">
                                <div class="main-node"
                                     :class="'status-' + node.status"
                                     :data-id="node.id"
                                     @contextmenu="showMenu($event, 'main', idx, -1)"
                                     @click="handleNodeClick(node.id, 'main', idx, -1)"
                                     v-html="highlight(node.title)"></div>
                            </div>
                            <div class="branch-connector"></div>
                            <div class="branch-cell">
                                <div v-if="node.children && node.children.length > 0"
                                     class="branch-node"
                                     :class="'status-' + node.children[0].status"
                                     :data-id="node.children[0].id"
                                     :data-main-id="node.id"
                                     @contextmenu="showMenu($event, 'branch', idx, 0)"
                                     @click="handleNodeClick(node.children[0].id, 'branch', idx, 0)"
                                     v-html="highlight(node.children[0].title)"></div>
                            </div>
                        </div>
                        <!-- 其余分支技能点单独一行 -->
                        <template v-if="node.children && node.children.length > 1">
                            <div class="roadmap-row" v-for="(branch, cidx) in node.children.slice(1)" :key="branch.id">
                                <div class="main-cell empty"></div>
                                <div class="branch-connector"></div>
                                <div class="branch-cell">
                                    <div class="branch-node"
                                         :class="'status-' + branch.status"
                                         :data-id="branch.id"
                                         :data-main-id="node.id"
                                         @contextmenu="showMenu($event, 'branch', idx, cidx+1)"
                                         @click="handleNodeClick(branch.id, 'branch', idx, cidx+1)"
                                         v-html="highlight(branch.title)"></div>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
                <!-- 右键菜单 -->
                <div v-if="contextMenu.show"
                     class="context-menu"
                     :style="{left: contextMenu.x + 'px', top: contextMenu.y + 'px'}"
                     @mousedown.stop>
                    <template v-if="contextMenu.type === 'main'">
                        <div class="context-menu-item" @click="insertDown(contextMenu.idx)">往下插入一个技能点</div>
                        <div class="context-menu-item" @click="insertRight(contextMenu.idx)">往右添加一个技能点</div>
                        <div class="context-menu-item" @click="editNode(contextMenu.idx, -1)">编辑技能点</div>
                        <div class="context-menu-item" @click="deleteNode(contextMenu.idx, -1)">删除技能点</div>
                        <div class="context-menu-item status-menu-parent"
                             @mouseenter="showStatusSubMenu('main')"
                             @mouseleave="hideStatusSubMenu">
                            学习状况修改 ▶
                            <div v-if="statusSubMenu === 'main'" class="context-menu-sub">
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, -1, 'todo')">待学习</div>
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, -1, 'doing')">学习中</div>
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, -1, 'done')">已学习</div>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="context-menu-item" @click="editNode(contextMenu.idx, contextMenu.cidx)">编辑技能点</div>
                        <div class="context-menu-item" @click="deleteNode(contextMenu.idx, contextMenu.cidx)">删除技能点</div>
                        <div class="context-menu-item status-menu-parent"
                             @mouseenter="showStatusSubMenu('branch')"
                             @mouseleave="hideStatusSubMenu">
                            学习状况修改 ▶
                            <div v-if="statusSubMenu === 'branch'" class="context-menu-sub">
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, contextMenu.cidx, 'todo')">待学习</div>
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, contextMenu.cidx, 'doing')">学习中</div>
                                <div class="context-menu-item" @click.stop="setStatus(contextMenu.idx, contextMenu.cidx, 'done')">已学习</div>
                            </div>
                        </div>
                    </template>
                </div>
                <!-- 技能点详情右侧抽屉 -->
                <transition name="slide-fade">
                <div v-if="nodeDetail.show" class="node-detail-drawer" @mousedown.stop>
                    <div class="drawer-header">
                        <span class="drawer-title">技能点详情</span>
                        <button class="drawer-close" @click="closeNodeDetail">×</button>
                    </div>
                    <div class="drawer-content">
                        <div class="drawer-title-row">
                            <template v-if="!editMode">
                                <div class="drawer-node-label">{{ nodeDetail.title }}</div>
                                <div class="drawer-status-row2">
                                    <span class="drawer-status-dot" :class="'status-' + nodeDetail.status"></span>
                                    <span class="drawer-status-text2">
                                        <span v-if="nodeDetail.status === 'todo'">待学习</span>
                                        <span v-else-if="nodeDetail.status === 'doing'">学习中</span>
                                        <span v-else>已学习</span>
                                    </span>
                                </div>
                            </template>
                            <template v-else>
                                <div class="drawer-edit-form-group">
                                    <label class="drawer-edit-label" for="editTitle">技能点标题</label>
                                    <input id="editTitle" v-model="editCache.title" class="drawer-edit-input" maxlength="30" />
                                </div>
                                <div class="drawer-edit-form-group">
                                    <label class="drawer-edit-label" for="editStatus">学习状态</label>
                                    <select id="editStatus" v-model="editCache.status" :class="'drawer-status-select status-' + editCache.status">
                                        <option value="todo">待学习</option>
                                        <option value="doing">学习中</option>
                                        <option value="done">已学习</option>
                                    </select>
                                </div>
                            </template>
                        </div>
                        <div class="drawer-label">备注</div>
                        <template v-if="!editMode">
                            <div class="drawer-remark drawer-remark-view" v-if="nodeDetail.remark">{{ nodeDetail.remark }}</div>
                            <div class="drawer-remark drawer-remark-view" v-else style="background:none;border:none;"></div>
                        </template>
                        <template v-else>
                            <div class="drawer-edit-form-group">
                                <textarea v-model="editCache.remark" class="drawer-edit-remark" placeholder="可填写对该技能点的理解、计划或备注…"></textarea>
                            </div>
                        </template>
                        <div class="drawer-btn-row">
                            <button
                              v-if="!editMode"
                              class="btn drawer-edit"
                              @click="startEditNodeDetail"
                            >编辑</button>
                            <span v-else>
                              <button
                                class="btn drawer-save"
                                @click="saveNodeEdit"
                              >保存</button>
                              <button
                                class="btn drawer-cancel"
                                @click="cancelNodeEdit"
                              >取消</button>
                            </span>
                        </div>
                        <hr style="margin:18px 0 10px 0;border:none;border-top:1.5px solid #e6eaf0;" />
                        <!-- 新增：md文件列表 -->
                        <div class="drawer-label" style="margin-top:0;">相关笔记</div>
                        <ul>
                            <li v-for="file in (Array.isArray(mdFiles.value) ? mdFiles.value : mdFiles)" :key="file.id">{{ file.name }}</li>
                        </ul>
                    </div>
                </div>
                </transition>
            </div>
        </div>
    </div>
    </div>
    <script>
const { createApp, ref, computed, onMounted, nextTick, watch, onUnmounted } = Vue;
const API_BASE = 'http://localhost:5000';
createApp({
    setup() {
        // 目标名
        const targetId = sessionStorage.getItem('roadmap_target_id') || '未命名目标';
        const userId = sessionStorage.getItem('roadmap_user_id') || '';
        // roadmap数据
        const data = ref([]);
        // 统计
        const mainCount = computed(() => data.value.length);
        const branchCount = computed(() => data.value.reduce((sum, n) => sum + (n.children ? n.children.length : 0), 0));
        // 主技能点状态统计
        const mainStatus = computed(() => {
            let todo=0, doing=0, done=0;
            data.value.forEach(n => {
                if(n.status==='todo') todo++;
                else if(n.status==='doing') doing++;
                else if(n.status==='done') done++;
            });
            return {todo, doing, done};
        });
        // 分支技能点状态统计
        const branchStatus = computed(() => {
            let todo=0, doing=0, done=0;
            data.value.forEach(n => {
                if(n.children) n.children.forEach(c => {
                    if(c.status==='todo') todo++;
                    else if(c.status==='doing') doing++;
                    else if(c.status==='done') done++;
                });
            });
            return {todo, doing, done};
        });
        // 分支技能点学习率
        const branchProgressPercent = computed(() => branchCount.value ? Math.round(branchStatus.value.done/branchCount.value*100) : 0);
        // 待办事项
        const todos = ref([]);
        const newTodoText = ref('');
        const showTodoAddForm = ref(false);
        async function fetchTodos() {
            const res = await fetch(`${API_BASE}/todos`, { credentials: 'include' });
            if (res.ok) {
                const result = await res.json();
                if (result.success) {
                    todos.value = result.data.map(todo => ({ ...todo, isDeleting: false }));
                } else {
                    todos.value = [];
                }
            } else {
                todos.value = [];
            }
        }
        async function addTodoApi(text) {
            await fetch(`${API_BASE}/todos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ text })
            });
            newTodoText.value = '';
            showTodoAddForm.value = false;
            await fetchTodos();
        }
        function openTodoForm() {
            newTodoText.value = '';
            showTodoAddForm.value = true;
            document.body.style.overflow = 'hidden';
        }
        function cancelAddTodoForm() {
            showTodoAddForm.value = false;
            newTodoText.value = '';
            document.body.style.overflow = '';
        }
        async function addTodoFromForm() {
            if (!newTodoText.value.trim()) {
                alert('待办事项不能为空！');
                return;
            }
            await addTodoApi(newTodoText.value.trim());
            document.body.style.overflow = '';
        }
        async function toggleTodoComplete(todo) {
            if (!todo.completed) {
                await fetch(`${API_BASE}/todos/${todo.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ completed: true })
                });
                todo.isDeleting = true;
                setTimeout(async () => {
                    await fetchTodos();
                }, 500);
            } else {
                await fetch(`${API_BASE}/todos/${todo.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ completed: false })
                });
                await fetchTodos();
            }
        }
        async function deleteTodo(todo) {
            await fetch(`${API_BASE}/todos/${todo.id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            await fetchTodos();
        }
        // roadmap API
        async function loadRoadmap() {
            const res = await fetch(`${API_BASE}/roadmap?target_id=${encodeURIComponent(targetId)}&user_id=${encodeURIComponent(userId)}`, {credentials: 'include'});
            if (res.ok) {
                data.value = await res.json();
            } else {
                data.value = [];
            }
        }
        // 右键菜单相关
        const contextMenu = ref({show: false, x: 0, y: 0, type: '', idx: -1, cidx: -1});
        const statusSubMenu = ref('');
        let statusMenuTimer = null;
        function showMenu(e, type, idx, cidx = -1) {
            e.preventDefault();
            contextMenu.value = {show: true, x: e.pageX, y: e.pageY, type, idx, cidx};
            setTimeout(() => {
                window.addEventListener('mousedown', onGlobalMenuClose, { once: true });
            }, 0);
        }
        function onGlobalMenuClose(e) {
            const menu = document.querySelector('.context-menu');
            if (menu && menu.contains(e.target)) return;
            hideMenu();
        }
        function hideMenu() {
            contextMenu.value.show = false;
            statusSubMenu.value = '';
        }
        function showStatusSubMenu(type) {
            if (statusMenuTimer) clearTimeout(statusMenuTimer);
            statusSubMenu.value = type;
        }
        function hideStatusSubMenu() {
            if (statusMenuTimer) clearTimeout(statusMenuTimer);
            statusMenuTimer = setTimeout(() => {
                statusSubMenu.value = '';
            }, 180);
        }
        // 技能点操作
        async function insertDown(idx) {
            openAddMainNodeModal(idx);
            hideMenu();
        }
        async function insertRight(idx) {
            const mainId = data.value[idx].id;
            openAddBranchNodeModal(mainId);
            hideMenu();
        }
        async function editNode(idx, cidx) {
            // 先打开技能点详情抽屉
            if (cidx === -1) {
                openNodeDetail('main', idx, -1);
            } else {
                openNodeDetail('branch', idx, cidx);
            }
            nextTick(() => {
                startEditNodeDetail();
            });
            hideMenu();
        }
        async function deleteNode(idx, cidx) {
            if (cidx === -1) {
                if (data.value.length === 1) {
                    alert('至少保留一个主线技能点');
                    hideMenu();
                    return;
                }
                if (confirm('确定要删除该技能点及其分支吗？')) {
                    const mainId = data.value[idx].id;
                    await deleteMainNode(mainId);
                }
            } else {
                if (confirm('确定要删除该分支技能点吗？')) {
                    const branchId = data.value[idx].children[cidx].id;
                    await deleteBranchNode(branchId);
                }
            }
            hideMenu();
        }
        async function setStatus(idx, cidx, status) {
            if (cidx === -1) {
                const node = data.value[idx];
                await updateMainNode(node.id, node.title, status, node.remark || '');
                // 主技能点设为待学习/已学习时，所有子技能点同步
                if ((status === 'todo' || status === 'done') && node.children) {
                    for (const child of node.children) {
                        await updateBranchNode(child.id, child.title, status, child.remark || '');
                    }
                }
            } else {
                const branch = data.value[idx].children[cidx];
                await updateBranchNode(branch.id, branch.title, status, branch.remark || '');
            }
            await loadRoadmap();
            hideMenu();
        }
        function dblJump(nodeId, type, mainId, branchId) {
            sessionStorage.setItem('md_user_id', userId);
            sessionStorage.setItem('md_target_id', targetId);
            sessionStorage.setItem('md_main_id', mainId);
            if (type === 'main') {
                sessionStorage.setItem('md_type', 'main');
                sessionStorage.removeItem('md_branch_id');
            } else {
                sessionStorage.setItem('md_type', 'branch');
                sessionStorage.setItem('md_branch_id', branchId);
            }
            window.location.href = 'index_md.html';
        }
        function uuid() { return 'n'+Math.random().toString(36).slice(2,10)+Date.now(); }
        // 保存（已废弃，所有操作走API）
        function save() {}
        // SVG箭头/虚线绘制
        const roadmapListRef = ref(null);
        function drawArrows() {
            // 清除旧SVG
            const list = roadmapListRef.value;
            if (!list) return;
            list.querySelectorAll('.main-arrow-abs, .branch-dash-abs').forEach(e => e.remove());
            // 主技能点中心
            const mainNodes = list.querySelectorAll('.main-node');
            // 主线箭头
            for (let i = 0; i < mainNodes.length - 1; ++i) {
                const from = mainNodes[i];
                const to = mainNodes[i + 1];
                if (!from || !to) continue;
                const fromRect = from.getBoundingClientRect();
                const toRect = to.getBoundingClientRect();
                const containerRect = list.getBoundingClientRect();
                const x = fromRect.left + fromRect.width / 2 - containerRect.left;
                const y1 = fromRect.bottom - containerRect.top;
                const y2 = toRect.top - containerRect.top;
                const markerSize = 8;
                const height = y2 - y1 + markerSize;
                const width = 32;
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.classList.add('main-arrow-abs');
                svg.style.left = (x - width/2) + 'px';
                svg.style.top = y1 + 'px';
                svg.style.width = width + 'px';
                svg.style.height = height + 'px';
                svg.style.overflow = 'visible';
                svg.setAttribute('width', width);
                svg.setAttribute('height', height);
                const lineEndY = height - 1 - markerSize * 2;
                svg.innerHTML = `<defs><marker id='arrowhead' markerWidth='8' markerHeight='8' refX='4' refY='4' orient='auto' markerUnits='strokeWidth'><path d='M0,0 L8,4 L0,8 Z' fill='#9cd6ff'/></marker></defs><line x1='${width/2}' y1='0' x2='${width/2}' y2='${lineEndY}' stroke='#9cd6ff' stroke-width='3' marker-end='url(#arrowhead)'/>`;
                list.appendChild(svg);
            }
            // 分支虚线
            const branchNodes = list.querySelectorAll('.branch-node');
            branchNodes.forEach(branch => {
                const mainId = branch.getAttribute('data-main-id');
                const main = list.querySelector(`.main-node[data-id='${mainId}']`);
                if (!main) return;
                const mainRect = main.getBoundingClientRect();
                const branchRect = branch.getBoundingClientRect();
                const containerRect = list.getBoundingClientRect();
                // 逻辑修正：始终以主节点右侧中心为起点，分支节点左侧中心为终点
                const x1 = mainRect.right - containerRect.left;
                const y1 = mainRect.top + mainRect.height/2 - containerRect.top;
                const x2 = branchRect.left - containerRect.left;
                const y2 = branchRect.top + branchRect.height/2 - containerRect.top;
                const width = x2 - x1;
                const height = y2 - y1;
                if (width < 10 && Math.abs(height) < 10) return;
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.classList.add('branch-dash-abs');
                svg.style.left = x1 + 'px';
                svg.style.top = (y1) + 'px';
                svg.style.width = width + 'px';
                svg.style.height = Math.abs(height) + 'px';
                svg.style.overflow = 'visible';
                svg.setAttribute('width', width);
                svg.setAttribute('height', Math.abs(height));
                // 只画水平虚线（如需斜线可用 line x1/y1/x2/y2）
                svg.innerHTML = `<line x1='0' y1='${height >= 0 ? 0 : Math.abs(height)}' x2='${width}' y2='${height >= 0 ? height : 0}' stroke='#9cd6ff' stroke-width='2' stroke-dasharray='6,6'/>`;
                list.appendChild(svg);
            });
        }
        // 多帧绘制，确保布局稳定
        function robustDrawArrows() {
            let frame = 0;
            function loop() {
                drawArrows();
                if (++frame < 8) requestAnimationFrame(loop);
            }
            loop();
        }
        // 监听数据变化和挂载后绘制
        onMounted(() => {
            nextTick(robustDrawArrows);
            loadRoadmap();
            fetchTodos();
            window.addEventListener('resize', robustDrawArrows);
        });
        onUnmounted(() => {
            window.removeEventListener('resize', robustDrawArrows);
        });
        watch(data, () => {
            nextTick(robustDrawArrows);
        }, {deep: true});
        // 技能点详情抽屉
        const nodeDetail = ref({show: false, type: '', idx: -1, cidx: -1, title: '', status: '', remark: ''});
        // 编辑模式相关
        const editMode = ref(false);
        const editCache = ref({ title: '', status: '', remark: '' });
        function openNodeDetail(type, idx, cidx) {
            editMode.value = false;
            let node, remark = '';
            if (type === 'main') {
                node = data.value[idx];
                remark = node.remark || '';
            } else {
                node = data.value[idx].children[cidx];
                remark = node.remark || '';
            }
            nodeDetail.value = {
                show: true,
                type,
                idx,
                cidx,
                title: node.title,
                status: node.status,
                remark
            };
            // 绑定全局点击关闭
            nextTick(() => {
                setTimeout(() => {
                    window.addEventListener('mousedown', onGlobalDrawerClose, { once: true });
                }, 0);
            });
        }
        function onGlobalDrawerClose(e) {
            // 如果点击在抽屉内，不关闭
            const drawer = document.querySelector('.node-detail-drawer');
            if (drawer && drawer.contains(e.target)) return;
            // 如果点击在技能点上（main-node/branch-node），不关闭
            if (e.target.closest('.main-node') || e.target.closest('.branch-node')) return;
            closeNodeDetail();
        }
        function closeNodeDetail() {
            nodeDetail.value.show = false;
        }
        function saveNodeRemark() {
            const { type, idx, cidx, remark } = nodeDetail.value;
            if (type === 'main') {
                data.value[idx].remark = remark;
            } else {
                data.value[idx].children[cidx].remark = remark;
            }
            save();
            nodeDetail.value.show = false;
        }
        function startEditNodeDetail() {
            console.log('startEditNodeDetail called');
            editCache.value = {
                title: nodeDetail.value.title,
                status: nodeDetail.value.status,
                remark: nodeDetail.value.remark
            };
            editMode.value = true;
        }
        function cancelNodeEdit() {
            editMode.value = false;
        }
        async function saveNodeEdit() {
            const { type, idx, cidx } = nodeDetail.value;
            if (editCache.value.title.trim() === '') {
                alert('技能点标题不能为空');
                return;
            }
            if (type === 'main') {
                await updateMainNode(data.value[idx].id, editCache.value.title.trim(), editCache.value.status, editCache.value.remark);
            } else {
                const branch = data.value[idx].children[cidx];
                await updateBranchNode(branch.id, editCache.value.title.trim(), editCache.value.status, editCache.value.remark);
            }
            await loadRoadmap();
            editMode.value = false;
            nextTick(() => {
                openNodeDetail(type, idx, cidx);
            });
        }
        async function addMainNode(title) {
            await fetch(`${API_BASE}/roadmap/main`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({title, target_id: targetId, user_id: userId})
            });
            await loadRoadmap();
        }
        async function addBranchNode(main_id, title) {
            await fetch(`${API_BASE}/roadmap/branch`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({main_id, title, target_id: targetId, user_id: userId})
            });
            await loadRoadmap();
        }
        async function updateMainNode(node_id, title, status, remark) {
            await fetch(`${API_BASE}/roadmap/main/${node_id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({title, status, remark, target_id: targetId, user_id: userId})
            });
            await loadRoadmap();
        }
        async function updateBranchNode(node_id, title, status, remark) {
            await fetch(`${API_BASE}/roadmap/branch/${node_id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({title, status, remark, target_id: targetId, user_id: userId})
            });
            await loadRoadmap();
        }
        async function deleteMainNode(node_id) {
            await fetch(`${API_BASE}/roadmap/main/${node_id}?target_id=${encodeURIComponent(targetId)}&user_id=${encodeURIComponent(userId)}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            await loadRoadmap();
        }
        async function deleteBranchNode(node_id) {
            await fetch(`${API_BASE}/roadmap/branch/${node_id}?target_id=${encodeURIComponent(targetId)}&user_id=${encodeURIComponent(userId)}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            await loadRoadmap();
        }
        let clickTimer = null;
        function handleNodeClick(nodeId, type, idx, cidx) {
            if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
                if (type === 'main') {
                    // 主节点双击，mainId=nodeId
                    dblJump(nodeId, 'main', nodeId, null);
                } else {
                    // 分支节点双击，mainId=data.value[idx].id, branchId=nodeId
                    const mainId = data.value[idx].id;
                    const branchId = data.value[idx].children[cidx].id;
                    dblJump(branchId, 'branch', mainId, branchId);
                }
            } else {
                clickTimer = setTimeout(() => {
                    openNodeDetail(type, idx, cidx);
                    clickTimer = null;
                }, 250);
            }
        }
        // --- 新增：md文件列表相关 ---
        let mdFiles = ref([]);
        async function loadMdFilesForNode() {
            if (!nodeDetail.value.show) return;
            const { type, idx, cidx } = nodeDetail.value;
            let mainId = null, branchId = null;
            if (type === 'main') {
                mainId = data.value[idx].id;
            } else if (type === 'branch') {
                mainId = data.value[idx].id;
                branchId = data.value[idx].children[cidx].id;
            }
            const res = await fetch(`http://127.0.0.1:5000/api/files?user_id=${encodeURIComponent(userId)}`);
            if (!res.ok) { mdFiles.value = []; window._mdFiles = mdFiles; return; }
            const result = await res.json();
            if (!result.success) { mdFiles.value = []; window._mdFiles = mdFiles; return; }
            mdFiles.value = result.data.filter(file => {
                if (!file.tags) return false;
                try {
                    const t = JSON.parse(file.tags);
                    if (String(t.userId) !== String(userId) || String(t.targetId) !== String(targetId) || String(t.mainId) !== String(mainId)) return false;
                    if (type === 'branch' && branchId) return String(t.branchId) === String(branchId);
                    if (type === 'main') return !!t.branchId;
                    return true;
                } catch (e) { return false; }
            });
            // 强制保证 mdFiles 还是 ref
            if (!mdFiles.value) mdFiles.value = [];
            window._mdFiles = mdFiles;
            console.log('loadMdFilesForNode后 mdFiles.value', mdFiles.value);
        }
        // 监听详情抽屉打开时加载md文件
        watch(nodeDetail, (val) => {
            if (val.show) loadMdFilesForNode();
        });
        // 双击打开md文件
        function openMdFile(file) {
            sessionStorage.setItem('md_user_id', userId);
            sessionStorage.setItem('md_target_id', targetId);
            sessionStorage.setItem('md_main_id', file.tags ? JSON.parse(file.tags).mainId : '');
            if (file.tags && JSON.parse(file.tags).branchId) {
                sessionStorage.setItem('md_type', 'branch');
                sessionStorage.setItem('md_branch_id', JSON.parse(file.tags).branchId);
            } else {
                sessionStorage.setItem('md_type', 'main');
                sessionStorage.removeItem('md_branch_id');
            }
            window.location.href = 'index_md.html';
        }
        // === window全局调试变量 ===
        window._mdFiles = mdFiles;
        window._appData = { mdFiles, data, nodeDetail };
        // === END ===
        // 搜索相关
        const search = ref('');
        // 搜索过滤后的 roadmap
        const filteredRoadmap = computed(() => data.value);
        // 高亮函数（优化样式）
        function highlight(text) {
            if (!search.value.trim()) return text;
            const s = search.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const reg = new RegExp(s, 'gi');
            return text.replace(reg, match => `<span class='search-highlight'>${match}</span>`);
        }
        // 搜索下拉联想相关
        const showDropdown = ref(false);
        const dropdownOptions = computed(() => {
            const s = search.value.trim().toLowerCase();
            const options = [];
            data.value.forEach(main => {
                // 主节点
                options.push({
                    id: main.id,
                    type: 'main',
                    label: main.title,
                    status: main.status,
                    parentId: null
                });
                // 分节点
                (main.children || []).forEach(child => {
                    options.push({
                        id: child.id,
                        type: 'branch',
                        label: child.title,
                        status: child.status,
                        parentId: main.id
                    });
                });
            });
            // 有搜索内容时才过滤
            if (s) {
                const filtered = [];
                data.value.forEach(main => {
                    let mainMatch = main.title.toLowerCase().includes(s);
                    let branchMatches = (main.children || []).filter(child => child.title.toLowerCase().includes(s));
                    if (mainMatch || branchMatches.length > 0) {
                        filtered.push({
                            id: main.id,
                            type: 'main',
                            label: main.title,
                            status: main.status,
                            parentId: null
                        });
                        branchMatches.forEach(child => {
                            filtered.push({
                                id: child.id,
                                type: 'branch',
                                label: child.title,
                                status: child.status,
                                parentId: main.id
                            });
                        });
                    }
                });
                return filtered;
            }
            return options;
        });
        // 定位并高亮节点
        function locateNode(option) {
            let selector = '';
            if (option.type === 'main') {
                selector = `.main-node[data-id='${option.id}']`;
            } else {
                selector = `.branch-node[data-id='${option.id}']`;
            }
            const el = document.querySelector(selector);
            if (el) {
                el.scrollIntoView({behavior: 'smooth', block: 'center'});
                el.classList.add('search-locate-highlight');
                setTimeout(() => {
                    el.classList.remove('search-locate-highlight');
                }, 1800);
            }
            showDropdown.value = false;
        }
        // 监听输入聚焦/失焦
        function onSearchFocus() { showDropdown.value = true; }
        function onSearchBlur() { setTimeout(() => { showDropdown.value = false; }, 200); }
        // 键盘上下选择
        const dropdownIndex = ref(-1);
        function onSearchKeydown(e) {
            if (!showDropdown.value || !dropdownOptions.value.length) return;
            if (e.key === 'ArrowDown') {
                dropdownIndex.value = (dropdownIndex.value + 1) % dropdownOptions.value.length;
                e.preventDefault();
            } else if (e.key === 'ArrowUp') {
                dropdownIndex.value = (dropdownIndex.value - 1 + dropdownOptions.value.length) % dropdownOptions.value.length;
                e.preventDefault();
            } else if (e.key === 'Enter') {
                if (dropdownIndex.value >= 0 && dropdownIndex.value < dropdownOptions.value.length) {
                    locateNode(dropdownOptions.value[dropdownIndex.value]);
                }
            }
        }
        // 计算下拉框高度：有选项时为min(4,选项数)*36px，无选项时为56px
        const dropdownHeight = computed(() => {
            const count = dropdownOptions.value.length;
            const h = count > 0 ? Math.min(count, 4) * 36 : 56;
            return h + 'px';
        });
        // setup() 内部新增变量和方法
        const showAddMainNodeModal = ref(false);
        const newMainNodeTitle = ref('');
        let addMainNodeInsertIdx = null;
        function openAddMainNodeModal(idx) {
            addMainNodeInsertIdx = idx;
            newMainNodeTitle.value = '';
            showAddMainNodeModal.value = true;
            document.body.style.overflow = 'hidden';
        }
        function cancelAddMainNodeModal() {
            showAddMainNodeModal.value = false;
            newMainNodeTitle.value = '';
            document.body.style.overflow = '';
        }
        async function addMainNodeFromModal() {
            if (!newMainNodeTitle.value.trim()) {
                alert('技能点标题不能为空！');
                return;
            }
            await addMainNode(newMainNodeTitle.value.trim());
            showAddMainNodeModal.value = false;
            newMainNodeTitle.value = '';
            document.body.style.overflow = '';
        }
        // setup() 内部新增变量和方法
        const showAddBranchNodeModal = ref(false);
        const newBranchNodeTitle = ref('');
        let addBranchNodeMainId = null;
        function openAddBranchNodeModal(mainId) {
            addBranchNodeMainId = mainId;
            newBranchNodeTitle.value = '';
            showAddBranchNodeModal.value = true;
            document.body.style.overflow = 'hidden';
        }
        function cancelAddBranchNodeModal() {
            showAddBranchNodeModal.value = false;
            newBranchNodeTitle.value = '';
            document.body.style.overflow = '';
        }
        async function addBranchNodeFromModal() {
            if (!newBranchNodeTitle.value.trim()) {
                alert('技能点标题不能为空！');
                return;
            }
            await addBranchNode(addBranchNodeMainId, newBranchNodeTitle.value.trim());
            showAddBranchNodeModal.value = false;
            newBranchNodeTitle.value = '';
            document.body.style.overflow = '';
        }
        return {
            targetId, data, mainCount, branchCount, mainStatus, branchStatus, branchProgressPercent, todos, newTodoText, showTodoAddForm, fetchTodos, addTodoApi, openTodoForm, cancelAddTodoForm, addTodoFromForm, toggleTodoComplete, deleteTodo,
            contextMenu, showMenu, hideMenu, insertDown, insertRight, editNode, deleteNode, setStatus, dblJump, roadmapListRef,
            statusSubMenu, showStatusSubMenu, hideStatusSubMenu, nodeDetail, openNodeDetail, closeNodeDetail, saveNodeRemark,
            editMode, editCache, startEditNodeDetail, cancelNodeEdit, saveNodeEdit, handleNodeClick, mdFiles, loadMdFilesForNode,
            openMdFile, search, filteredRoadmap, highlight,
            showDropdown, dropdownOptions, locateNode, onSearchFocus, onSearchBlur, dropdownIndex, onSearchKeydown,
            dropdownHeight, showAddMainNodeModal, newMainNodeTitle, openAddMainNodeModal, cancelAddMainNodeModal, addMainNodeFromModal,
            showAddBranchNodeModal, newBranchNodeTitle, openAddBranchNodeModal, cancelAddBranchNodeModal, addBranchNodeFromModal
        };
    }
}).mount('#app');
    </script>
</body>
</html>